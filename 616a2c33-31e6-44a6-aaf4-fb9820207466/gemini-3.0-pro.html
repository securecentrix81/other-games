<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Durr Yussef Sux - The Game</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; }
        #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        .hud-top { padding: 20px; display: flex; justify-content: space-between; color: white; text-shadow: 2px 2px 4px black; font-weight: bold; font-size: 24px; }
        .gpa-container { background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; width: 300px; }
        .gpa-bar-bg { width: 100%; height: 20px; background: #555; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .gpa-bar-fill { height: 100%; background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00); width: 100%; transition: width 0.2s; }
        #message-area { position: absolute; top: 20%; width: 100%; text-align: center; color: #ffeb3b; font-size: 32px; font-weight: bold; text-shadow: 3px 3px 0 #000; opacity: 0; transition: opacity 0.5s; }
        #yelling-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; justify-content: center; align-items: center; flex-direction: column; background: rgba(255, 0, 0, 0.2); animation: flash 0.5s infinite; }
        @keyframes flash { 0% { opacity: 0.5; } 50% { opacity: 0.8; } 100% { opacity: 0.5; } }
        .yell-text { font-size: 60px; color: red; font-weight: 900; text-transform: uppercase; text-shadow: 4px 4px 0 black; transform: rotate(-10deg); }
        
        #start-screen, #game-over-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); display: flex; flex-direction: column; 
            align-items: center; justify-content: center; color: white; pointer-events: auto; z-index: 10;
        }
        .btn { background: #3b82f6; color: white; padding: 15px 30px; border-radius: 8px; font-size: 24px; border: none; cursor: pointer; margin-top: 20px; transition: transform 0.1s; }
        .btn:hover { transform: scale(1.05); background: #2563eb; }
        .hidden { display: none !important; }
        
        .tutorial { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-top: 20px; max-width: 600px; text-align: center; }
    </style>
    <!-- Import Three.js -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div id="game-container"></div>
    
    <div id="ui-layer">
        <div class="hud-top">
            <div class="gpa-container">
                <div id="gpa-text">GPA: 4.0</div>
                <div class="gpa-bar-bg"><div id="gpa-bar" class="gpa-bar-fill"></div></div>
            </div>
            <div id="score-display">Score: 0</div>
        </div>
        <div id="message-area">MISSION: FIND SAHARSH AND BULLY HIM!</div>
    </div>

    <div id="yelling-overlay">
        <div class="yell-text">WHY YOU FAIL?!</div>
        <div class="yell-text" style="font-size: 40px; transform: rotate(5deg); margin-top: 20px;">FAILURE!</div>
        <div class="yell-text" style="font-size: 50px; transform: rotate(-5deg); margin-top: 20px;">STUDY HARDER!</div>
    </div>

    <div id="start-screen">
        <h1 class="text-6xl font-bold mb-4 text-yellow-400">Durr Yussef Sux</h1>
        <h2 class="text-3xl mb-8 text-gray-300">School Simulator: Extreme Edition</h2>
        
        <div class="tutorial">
            <p class="mb-2 text-xl">üéØ <strong>Objective:</strong> Find Saharsh and... "interact" with him.</p>
            <p class="mb-2 text-xl">üèÉ <strong>Then:</strong> Run from angry teachers!</p>
            <p class="mb-2 text-xl">üìö <strong>Collect:</strong> <span class="text-green-400 font-bold">A+</span> grades to boost GPA.</p>
            <p class="mb-2 text-xl">‚ö†Ô∏è <strong>Avoid:</strong> <span class="text-red-400 font-bold">F</span> grades. Don't let parents yell at you!</p>
            <p class="mt-4 text-yellow-200">Controls: WASD or Arrows to Move | SPACE to Jump</p>
        </div>

        <button class="btn" id="start-btn">Start Game</button>
    </div>

    <div id="game-over-screen" class="hidden">
        <h1 class="text-6xl font-bold mb-4 text-red-500">DETENTION!</h1>
        <p id="game-over-reason" class="text-2xl mb-4">You were caught by a teacher.</p>
        <p id="final-score" class="text-3xl mb-8 text-yellow-400">Final Score: 0</p>
        <button class="btn" id="restart-btn">Try Again</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { RoundedBoxGeometry } from 'three/addons/geometries/RoundedBoxGeometry.js';

        // --- Game Constants ---
        const SAHARSH_IMG_URL = "https://asset-cdn.schoology.com/system/files/imagecache/profile_big/pictures/picture-c0b09cdead19788fb0f8be0d53b5c572_68c34cd700b90.jpg";
        const PLAYER_SPEED = 15;
        const TEACHER_SPEED = 9; // Slower than player but relentless
        const JUMP_FORCE = 25;
        const GRAVITY = 70;
        const WORLD_SIZE = 200;

        // --- State Variables ---
        let scene, camera, renderer, clock;
        let player, saharsh;
        let teachers = [];
        let grades = [];
        let mixers = [];
        let keys = { w: false, a: false, s: false, d: false, space: false };
        let playerVelocity = new THREE.Vector3();
        let isGrounded = false;
        let gameActive = false;
        let phase = 'FIND_SAHARSH'; // FIND_SAHARSH, RUN
        let gpa = 4.0;
        let score = 0;
        let yellingActive = false;
        let saharshTexture;
        let gradeSpawnInterval;

        // --- Initialization ---
        function init() {
            // Scene Setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB); // Sky blue
            scene.fog = new THREE.Fog(0x87CEEB, 20, 100);

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('game-container').appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(50, 100, 50);
            dirLight.castShadow = true;
            dirLight.shadow.camera.left = -100;
            dirLight.shadow.camera.right = 100;
            dirLight.shadow.camera.top = 100;
            dirLight.shadow.camera.bottom = -100;
            dirLight.shadow.mapSize.width = 2048;
            dirLight.shadow.mapSize.height = 2048;
            scene.add(dirLight);

            // Texture Loader
            const textureLoader = new THREE.TextureLoader();
            saharshTexture = textureLoader.load(SAHARSH_IMG_URL);

            // Create World
            createWorld();
            
            // Create Player
            createPlayer();

            // Create Saharsh
            createSaharsh();

            // Event Listeners
            window.addEventListener('resize', onWindowResize);
            document.addEventListener('keydown', (e) => onKey(e, true));
            document.addEventListener('keyup', (e) => onKey(e, false));

            // Start Loop
            clock = new THREE.Clock();
            animate();
        }

        function createWorld() {
            // Floor
            const floorGeometry = new THREE.PlaneGeometry(WORLD_SIZE, WORLD_SIZE);
            const floorMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x444444, 
                roughness: 0.8 
            });
            // Add a grid texture or checkerboard logic if possible, but simple color is fine
            // Let's make it look like tiles
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#e0e0e0';
            ctx.fillRect(0,0,512,512);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0,0,256,256);
            ctx.fillRect(256,256,256,256);
            const tileTex = new THREE.CanvasTexture(canvas);
            tileTex.wrapS = THREE.RepeatWrapping;
            tileTex.wrapT = THREE.RepeatWrapping;
            tileTex.repeat.set(20, 20);
            floorMaterial.map = tileTex;

            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            // Walls/Obstacles
            const wallGeo = new THREE.BoxGeometry(4, 6, 4);
            const wallMat = new THREE.MeshStandardMaterial({ color: 0x8B4513 }); // Lockers color
            
            // Create random pillars/lockers
            for(let i=0; i<40; i++) {
                const wall = new THREE.Mesh(wallGeo, wallMat);
                const x = (Math.random() - 0.5) * (WORLD_SIZE - 10);
                const z = (Math.random() - 0.5) * (WORLD_SIZE - 10);
                
                // Don't spawn too close to center
                if(Math.abs(x) < 10 && Math.abs(z) < 10) continue;

                wall.position.set(x, 3, z);
                wall.castShadow = true;
                wall.receiveShadow = true;
                scene.add(wall);
                
                // Add collision box to a global list if we were doing complex collision, 
                // but for now we'll just simple-collide or clip through (simple game constraint)
            }
        }

        function createPlayer() {
            const geometry = new RoundedBoxGeometry(1, 2, 1, 4, 0.1);
            const material = new THREE.MeshStandardMaterial({ color: 0x3b82f6 });
            player = new THREE.Mesh(geometry, material);
            player.position.set(0, 2, 0); // Start in center
            player.castShadow = true;
            
            // Add "Yussef" label?
            // Simple eyes
            const eyeGeo = new THREE.SphereGeometry(0.15);
            const eyeMat = new THREE.MeshBasicMaterial({ color: 0x000000 });
            const leftEye = new THREE.Mesh(eyeGeo, eyeMat);
            leftEye.position.set(-0.2, 0.5, 0.45);
            const rightEye = new THREE.Mesh(eyeGeo, eyeMat);
            rightEye.position.set(0.2, 0.5, 0.45);
            player.add(leftEye);
            player.add(rightEye);

            scene.add(player);
        }

        function createSaharsh() {
            const geometry = new THREE.BoxGeometry(1.5, 1.5, 1.5);
            // Apply texture to all sides or just front
            const materials = [
                new THREE.MeshStandardMaterial({ color: 0xaaaaaa }),
                new THREE.MeshStandardMaterial({ color: 0xaaaaaa }),
                new THREE.MeshStandardMaterial({ color: 0xaaaaaa }),
                new THREE.MeshStandardMaterial({ color: 0xaaaaaa }),
                new THREE.MeshStandardMaterial({ map: saharshTexture }), // Front
                new THREE.MeshStandardMaterial({ color: 0xaaaaaa }),
            ];
            
            saharsh = new THREE.Mesh(geometry, materials);
            // Place randomly
            const angle = Math.random() * Math.PI * 2;
            const dist = 20 + Math.random() * 20;
            saharsh.position.set(Math.cos(angle) * dist, 1.5, Math.sin(angle) * dist);
            saharsh.castShadow = true;
            scene.add(saharsh);

            // Floating indicator
            const div = document.createElement('div');
            // We will update indicator in loop
        }

        function createTeacher(x, z) {
            const h = 3;
            const geometry = new THREE.CapsuleGeometry(0.6, h-1.2, 4, 8);
            const material = new THREE.MeshStandardMaterial({ color: 0x880000 });
            const teacher = new THREE.Mesh(geometry, material);
            teacher.position.set(x, h/2, z);
            teacher.castShadow = true;
            
            // Teacher angry face
            const faceGeo = new THREE.PlaneGeometry(0.8, 0.8);
            // Draw angry face on canvas
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffccaa';
            ctx.fillRect(0,0,64,64);
            ctx.fillStyle = 'black';
            ctx.beginPath(); // Angry eyebrows
            ctx.moveTo(10, 20); ctx.lineTo(30, 30);
            ctx.moveTo(54, 20); ctx.lineTo(34, 30);
            ctx.stroke();
            ctx.beginPath(); // Eyes
            ctx.arc(20, 35, 5, 0, Math.PI*2);
            ctx.arc(44, 35, 5, 0, Math.PI*2);
            ctx.fill();
            ctx.beginPath(); // Mouth
            ctx.arc(32, 55, 10, Math.PI, 0);
            ctx.stroke();
            
            const tex = new THREE.CanvasTexture(canvas);
            const face = new THREE.Mesh(faceGeo, new THREE.MeshBasicMaterial({ map: tex, transparent: true }));
            face.position.set(0, 0.8, 0.61);
            teacher.add(face);

            scene.add(teacher);
            teachers.push({ mesh: teacher, speed: TEACHER_SPEED + Math.random() * 2 });
        }

        function spawnGrade() {
            if (!gameActive) return;
            
            const isGood = Math.random() > 0.3; // 70% chance of good grade if we want playability, but user said "collect A+, lower is bad".
            // Let's make A+ rare (30%) and others common (70%) to increase difficulty? 
            // Or maybe 50/50. Let's go 50/50.
            
            const type = isGood ? 'A+' : (Math.random() > 0.5 ? 'F' : 'D');
            const color = isGood ? '#00ff00' : '#ff0000';
            
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = color;
            ctx.font = 'bold 100px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(type, 64, 64);
            
            const tex = new THREE.CanvasTexture(canvas);
            const mat = new THREE.SpriteMaterial({ map: tex });
            const sprite = new THREE.Sprite(mat);
            
            const angle = Math.random() * Math.PI * 2;
            const dist = 10 + Math.random() * (WORLD_SIZE/2 - 10);
            sprite.position.set(
                player.position.x + (Math.random()-0.5)*40, 
                1.5 + Math.random(), 
                player.position.z + (Math.random()-0.5)*40
            );
            
            // Keep within bounds
            sprite.position.x = Math.max(Math.min(sprite.position.x, WORLD_SIZE/2), -WORLD_SIZE/2);
            sprite.position.z = Math.max(Math.min(sprite.position.z, WORLD_SIZE/2), -WORLD_SIZE/2);

            sprite.scale.set(1.5, 1.5, 1.5);
            scene.add(sprite);
            grades.push({ mesh: sprite, type: type, value: isGood ? 0.1 : -0.3 });
        }

        // --- Input Handling ---
        function onKey(e, pressed) {
            const k = e.key.toLowerCase();
            if (k === 'w' || k === 'arrowup') keys.w = pressed;
            if (k === 'a' || k === 'arrowleft') keys.a = pressed;
            if (k === 's' || k === 'arrowdown') keys.s = pressed;
            if (k === 'd' || k === 'arrowright') keys.d = pressed;
            if (k === ' ') keys.space = pressed;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- Game Logic ---
        function startGame() {
            if (gradeSpawnInterval) clearInterval(gradeSpawnInterval);
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
            gameActive = true;
            phase = 'FIND_SAHARSH';
            gpa = 4.0;
            score = 0;
            updateUI();
            
            // Reset player
            player.position.set(0, 2, 0);
            playerVelocity.set(0,0,0);
            
            // Reset entities
            teachers.forEach(t => scene.remove(t.mesh));
            teachers = [];
            grades.forEach(g => scene.remove(g.mesh));
            grades = [];
            
            if(saharsh) scene.remove(saharsh);
            createSaharsh();
            
            showMessage("FIND SAHARSH!", 3000);
        }

        function gameOver(reason) {
            if (gradeSpawnInterval) clearInterval(gradeSpawnInterval);
            gameActive = false;
            document.getElementById('game-over-screen').classList.remove('hidden');
            document.getElementById('game-over-reason').innerText = reason;
            document.getElementById('final-score').innerText = `Final Score: ${Math.floor(score)}`;
            document.getElementById('yelling-overlay').style.display = 'none';
        }

        function showMessage(text, duration) {
            const el = document.getElementById('message-area');
            el.innerText = text;
            el.style.opacity = 1;
            setTimeout(() => { el.style.opacity = 0; }, duration);
        }

        function triggerChase() {
            phase = 'RUN';
            showMessage("BULLIED! TEACHERS INCOMING!", 3000);
            
            // Spawn teachers
            for(let i=0; i<3; i++) {
                const angle = Math.random() * Math.PI * 2;
                const dist = 30;
                createTeacher(
                    player.position.x + Math.cos(angle)*dist,
                    player.position.z + Math.sin(angle)*dist
                );
            }
            
            // Remove Saharsh
            scene.remove(saharsh);
            saharsh = null;
            
            // Start spawning grades
            gradeSpawnInterval = setInterval(spawnGrade, 1000);
        }

        function updatePlayer(dt) {
            if (!player) return;

            // Input Vector
            const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
            forward.y = 0; forward.normalize();
            const right = new THREE.Vector3(1, 0, 0).applyQuaternion(camera.quaternion);
            right.y = 0; right.normalize();

            const moveDir = new THREE.Vector3();
            if (keys.w) moveDir.add(forward);
            if (keys.s) moveDir.sub(forward);
            if (keys.a) moveDir.sub(right);
            if (keys.d) moveDir.add(right);

            if (moveDir.length() > 0) moveDir.normalize();

            // Move Logic
            playerVelocity.x = moveDir.x * PLAYER_SPEED;
            playerVelocity.z = moveDir.z * PLAYER_SPEED;

            // Jump
            if (keys.space && isGrounded) {
                playerVelocity.y = JUMP_FORCE;
                isGrounded = false;
            }

            // Gravity
            playerVelocity.y -= GRAVITY * dt;

            // Apply Position
            player.position.add(playerVelocity.clone().multiplyScalar(dt));

            // Floor Collision
            if (player.position.y <= 1) { // 1 is half-height
                player.position.y = 1;
                playerVelocity.y = 0;
                isGrounded = true;
            }

            // Rotate player to face movement
            if (moveDir.length() > 0.1) {
                const targetRotation = Math.atan2(moveDir.x, moveDir.z);
                player.rotation.y = targetRotation;
            }
            
            // Bounds check (simple clamping)
            const halfSize = WORLD_SIZE/2;
            player.position.x = Math.max(Math.min(player.position.x, halfSize), -halfSize);
            player.position.z = Math.max(Math.min(player.position.z, halfSize), -halfSize);
        }

        function updateCamera() {
            // Third person follow
            const offset = new THREE.Vector3(0, 10, 15);
            const targetPos = player.position.clone().add(offset);
            camera.position.lerp(targetPos, 0.1);
            camera.lookAt(player.position);
        }

        function updateTeachers(dt) {
            teachers.forEach(t => {
                const dir = new THREE.Vector3().subVectors(player.position, t.mesh.position);
                dir.y = 0;
                dir.normalize();
                
                t.mesh.position.add(dir.multiplyScalar(t.speed * dt));
                t.mesh.lookAt(player.position);
                
                // Collision with player
                const dist = t.mesh.position.distanceTo(player.position);
                if (dist < 2) {
                    gameOver("You were caught by a teacher!");
                }
            });
        }

        function updateGrades(dt) {
            for (let i = grades.length - 1; i >= 0; i--) {
                const g = grades[i];
                g.mesh.rotation.y += 2 * dt;
                
                // Floating effect
                g.mesh.position.y = 2 + Math.sin(Date.now() * 0.005 + i) * 0.5;

                const dist = g.mesh.position.distanceTo(player.position);
                if (dist < 2) {
                    // Collect
                    if (g.type === 'A+') {
                        score += 100;
                        gpa = Math.min(4.0, gpa + g.value);
                        showMessage("A+! GPA UP!", 1000);
                    } else {
                        score -= 50;
                        gpa = Math.max(0.0, gpa + g.value); // value is negative
                        showMessage(g.type + "! GPA DOWN!", 1000);
                    }
                    
                    scene.remove(g.mesh);
                    grades.splice(i, 1);
                    updateUI();
                }
            }
        }

        function checkSaharshCollision() {
            if (!saharsh) return;
            const dist = player.position.distanceTo(saharsh.position);
            if (dist < 2.5) {
                triggerChase();
            }
        }

        function updateUI() {
            const gpaEl = document.getElementById('gpa-text');
            const barEl = document.getElementById('gpa-bar');
            const scoreEl = document.getElementById('score-display');
            const yellEl = document.getElementById('yelling-overlay');
            
            gpaEl.innerText = "GPA: " + gpa.toFixed(2);
            scoreEl.innerText = "Score: " + Math.floor(score);
            
            const percent = (gpa / 4.0) * 100;
            barEl.style.width = percent + '%';
            
            // Color change based on GPA
            if(gpa > 3.0) barEl.style.background = '#00ff00';
            else if(gpa > 2.0) barEl.style.background = '#ffff00';
            else barEl.style.background = '#ff0000';
            
            // Yelling effect
            if (gpa < 2.0) {
                yellEl.style.display = 'flex';
            } else {
                yellEl.style.display = 'none';
            }
            
            if (gpa <= 0) {
                gameOver("Your GPA hit 0.0! Your parents grounded you forever.");
            }
        }

        // --- Main Loop ---
        function animate() {
            requestAnimationFrame(animate);
            
            const dt = clock.getDelta();

            if (gameActive) {
                updatePlayer(dt);
                updateCamera();
                
                if (phase === 'FIND_SAHARSH') {
                    checkSaharshCollision();
                } else if (phase === 'RUN') {
                    updateTeachers(dt);
                    updateGrades(dt);
                    
                    // Score over time
                    score += dt * 10;
                    updateUI();
                }
            }

            renderer.render(scene, camera);
        }

        // Start button logic
        document.getElementById('start-btn').addEventListener('click', startGame);
        document.getElementById('restart-btn').addEventListener('click', startGame);

        // Init
        init();

    </script>
</body>
</html>
